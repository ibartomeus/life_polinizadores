---
title: "\\Large Effects of short-term restoration on plant-pollinator communities in Cantavieja and Ejea de los Caballeros"
output:
  pdf_document: default
  latex_engine: xelatex
bibliography: ../references.bib
linkcolor: Gray
urlcolor: Gray
fontfamily: mathpazo
fontsize: 12pt
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage[skip=3pt]{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{setspace}
- \usepackage{titling}
- \setlength{\droptitle}{-2.5cm}
- \usepackage[style=apa]{biblatex}
- \usepackage[labelformat = empty]{caption}
- \usepackage{pdflscape}
---

\vspace{-1.2cm}
\textcolor{gray}{\textit{January 2025}}
\begin{center}
\small
\textbf{Data collection:} O. Aguado | \textbf{Analysis:} J. B. Lanuza and I. Bartomeus | \textbf{Coordination:} E. Nuñez \\
\end{center}

# Index

- [Objectives](#objectives)
- [Sampling method](#sampling-method)
- [Comparative analysis](#comparative-analysis)
  - [Species richness and interactions](#species-richness-and-interactions)
  - [Network descriptors](#network-descriptors)
  - [Network structure](#network-structure)
- [Conclusions](#conclusions)

```{r setup, echo=FALSE, warning=FALSE}
# set global chunk options: 
library(knitr)
opts_chunk$set(cache=FALSE, autodep = TRUE)
#dep_auto()

```

## Objectives

The objective of this report is to describe the differences between two plant-pollinator communities located in Cantavieja and Ejea de los Caballeros before and after restoration practices. In this report, we compare the two plant-pollinator communities using the following methods: 1) rarefaction analysis of the number of species and unique interactions, 2) computation of network descriptors, and 3) evaluation of general aspects of network structure. 

All data manipulation and analyses were conducted in R version 4.1.2 [@R]. 

## Sampling method

Two distinct locations were monitored with different historical land-use and management in the region of Aragón (Spain): Cantavieja (40º 30' 44", N 0º 22' 59" W) at 1450m above sea level with a total of 30 plots and Ejea de los Caballeros (42º 01' 06" N, 1º 08' 53" W) at 350m. In each location, a total of 21 plots were monitored in 2021 and 2024. Plot size is 2m by 2m and they are randomly distributed within each location (see **Figure 1**). Importantly, since the start of the project vegetation has remained undisturbed without grazing or clearing. 

Each plot was surveyed three times at the begining of the season, at the peak of flowering and at the end of the season. In each occasion, all plant-pollinator interactions observed were documented. Pollinator specimens not identified in the field were captured and identified in the lab.


```{r echo=FALSE, out.width='80%',fig.align='center',fig.cap="\\textbf{Figure 1.} Cantavieja (left) and Ejea de los Caballeros (right) locations, with the different sampling plots indicated by an orange square along with the plot identifier. The positions of the bee hives are shown with a white cross in both locations."}

knitr::include_graphics('../Images/Sampling_sites.png')
```

## Comparative analysis

### \textcolor{gray}{1. Species Richness and Interactions}

In this section, we first described the species accumulation curves per location and year. For this, we used rarefaction analysis to compare the number of observed species at equal number of sampling rounds. Thus, several species accumulation curves are created by randomly selecting each sampling round, and then calculating the mean of all these curves. Cantavieja and Ejea de los Caballeros showed a higher number of pollinator species in 2024. (**Figure 3**). However, the difference between years was only particularly pronounced for Ejea de los Caballeros.


```{r echo=F, fig.align='center', message=FALSE, warning=FALSE, out.width="85%", fig.width=10, fig.cap="\\textbf{Figure 2.} Rarefied species accumulation curves across sampling rounds in Cantavieja and Ejea de los Caballeros. The solid line indicates the rarefied number of species per sampling round, the dot represents the observed number of species, and the dashed line shows the extrapolated number of species if additional rounds were conducted."}

library(ggplot2)

p1 = readRDS("../Data/cantavieja_sampling_curve.rds")
p2 = readRDS("../Data/ejea_sampling_curve.rds")

p1 = p1 + theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))
p2 = p2 + theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
  axis.title = element_text(size=14),
                axis.text = element_text(size=12))

library(patchwork)
p1 + p2

```


Second, we compared the number of observed pollinator and plant species per location and year. As showed in **Figure 3**, both Cantavieja and Ejea de los Caballeros showed more pollinator species in the year 2024 (**Figure 4**). However, the number of observed plant species was higher in 2021 for both locations. 

```{r echo=F, fig.align='center', message=FALSE, warning=FALSE, out.width="85%", fig.width=10, fig.cap="\\textbf{Figure 3.} Pollinator and plant richness in Cantavieja and Ejea de los Caballeros for the sampling periods 2021 and 2024."}

#Read data from 2021 and 2024
#First,load libraries
library(dplyr)
library(reshape2)
library(stringr)
library(ggplot2)
#Read data
data_2021 = read.csv("../Data/life_polinizadores_2021.csv")
data_2024 = read.csv("../Data/life_polinizadores_2024.csv")
#Combine data
all_data = bind_rows(data_2021, data_2024)
#Rename ejea caballeros to only ejea
all_data = all_data %>%
mutate(site_id = if_else(site_id == "ejea caballeros",
                "ejea", site_id))

#Delete leading and trailing spaces in spp names
all_data = all_data %>%
mutate(pollinators = trimws(pollinators)) %>%
mutate(plants = trimws(plants))

#Create a site_id label with year
#and select only cols of interest
main_cols = all_data %>%
mutate(locality = site_id) %>%
mutate(date = paste(day,month,year,transect, sep = "_")) %>%
mutate(site_id = paste0(site_id, "_" ,year)) %>%
mutate(site_id = str_replace_all(site_id, " ", "_")) %>%
select(locality, site_id, date, transect,  plants, pollinators)

#Get number of species of plants and pollinators
#per location and year (site_id has already year on it)
n_spp = main_cols %>%
group_by(site_id) %>%
summarise(n_pollinators = n_distinct(pollinators),
          n_plants = n_distinct(plants))

n_spp$site = c("Cantavieja", "Cantavieja","Ejea", "Ejea")
n_spp$Year = c("2021", "2024","2021", "2024")

p1 = n_spp %>%
ggplot(aes(site, n_pollinators, fill = Year), group = Year) +
geom_col(position = "dodge", alpha=0.9) +
scale_fill_manual(values = c("black", "tomato4")) +
theme_bw() +
coord_cartesian(expand = FALSE) +
xlab(NULL) +
ylab("Species") +
ggtitle("Pollinators")+ theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))


p2 = n_spp %>%
ggplot(aes(site, n_plants, fill = Year), group = Year) +
geom_col(position = "dodge", alpha=0.9) +
scale_fill_manual(values = c("black", "tomato4")) +
theme_bw() +
coord_cartesian(expand = FALSE) +
xlab(NULL) +
ylab("Species") +
ggtitle("Plants")+ theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))

library(patchwork)
p1+p2


```

Third, the rarefied accumulation curve of unique interactions was calculated for each location and year. Note that _Apis mellifera_ was excluded, as their individuals do not directly respond to the applied restoration practices. An example of unique interaction is the visit of _Amegilla quadrifasciata_ on _Eryngium campestre_, which was observed in both locations. Here, we observed similar patterns to the ones observed for the accumulation curve of pollinator species, where Cantavieja shows little differences between years but Ejea de los Caballeros shows notably more unique interactions for the year 2024.


```{r echo=F, fig.align='center', message=FALSE, warning=FALSE, out.width="85%", fig.width=10, fig.cap="\\textbf{Figure 4.} Comparison of the rarefied number of unique interactions across years in Cantavieja and Ejea de los Caballeros. Note that \\textit{Apis mellifera} were excluded from this analysis."}

library(cowplot)
library(ggplot2)

p1 = readRDS("../Data/cantavieja_interaction_curves.rds")
p2 = readRDS("../Data/ejea_interaction_curves.rds")

p1 = p1 + theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))
p2 = p2 + theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
  axis.title = element_text(size=14),
                axis.text = element_text(size=12))

library(patchwork)
p1+ p2


```


Fourth, we compared the degree distributions between the pollinator and plant communities of Cantavieja and Ejea de los Caballeros across different years. Pollinators exhibited a classical decaying distribution for ecological networks [@jordano2003], while plants had a more gradual decaying distribution. Pollinators did not show statistical differences between their distributions between years for both locations (Kruskal-Wallis _P_ > 0.05). However, plants had statistically different distributions for both locations (Kruskal-Wallis _P_ < 0.05).



```{r echo=F, fig.align='center', message=FALSE, warning=FALSE, out.width="85%", fig.width=10,fig.height=8, fig.cap="\\textbf{Figure 5.} Comparison of the pollinator and plant degree distributions for Cantavieja and Ejea de los Caballeros between years."}

#Read data
data_2021 = read.csv("../Data/life_polinizadores_2021.csv")
data_2024 = read.csv("../Data/life_polinizadores_2024.csv")
#Combine data
all_data = bind_rows(data_2021, data_2024)
#Rename ejea caballeros to only ejea
all_data = all_data %>%
mutate(site_id = if_else(site_id == "ejea caballeros",
                "ejea", site_id))

#Delete leading and trailing spaces in spp names
all_data = all_data %>%
mutate(pollinators = trimws(pollinators)) %>%
mutate(plants = trimws(plants))

#Create a site_id label with year
#and select only cols of interest
main_cols = all_data %>%
mutate(locality = site_id) %>%
mutate(date = paste(day,month,year,transect, sep = "_")) %>%
mutate(site_id = paste0(site_id, "_" ,year)) %>%
mutate(site_id = str_replace_all(site_id, " ", "_")) %>%
select(locality, site_id, year, transect,  plants, pollinators) %>%
filter(!str_detect(pollinators, " sp")) %>%
filter(!str_detect(plants, " sp")) %>%
mutate(locality = if_else(locality== "cantavieja", "Cantavieja", "Ejea"))

#Calculate degree distributions for pollinators-----
degree_dist = main_cols %>%
group_by(site_id, locality, year, pollinators) %>%
summarise(degree = n_distinct(plants))

#Plot degree distributions
p1 = degree_dist %>%
  ggplot(aes(degree, fill = factor(year),colour = factor(year), group = year, alpha= factor(year))) +
  geom_histogram(bins = 50, binwidth = 0.8, position = "identity") +
  geom_density(aes(y = after_stat(count) * 0.6,colour = factor(year), group = year), alpha = .3) +
  facet_wrap(~locality) +
  theme_bw() +
  labs(title = "Pollinators degree distribution",
       x = "Degree",
       y = "Frequency") +
  scale_fill_manual(name = "Year",values = c("2021" = "black", "2024" = "tomato4")) +
  scale_color_manual(name = "Year",values = c("2021" = "black", "2024" = "tomato4")) +
  scale_alpha_manual(name = "Year",values = c("2021" = 0.8, "2024" = 0.2)) + 
  theme(
  plot.title = element_text(size=18, face= "bold"), 
  axis.text = element_text(size=12),
  panel.border = element_rect(size=1.3), 
  strip.text = element_text(size=14, face = "bold"),
  strip.background = element_blank()
  )+
coord_cartesian(expand = FALSE)

#Calculate degree distributions for plants-----
degree_dist = main_cols %>%
group_by(site_id, locality, year, plants) %>%
summarise(degree = n_distinct(pollinators))

#Plot degree distributions
p2 = degree_dist %>%
  ggplot(aes(degree, fill = factor(year),colour = factor(year), group = year, alpha= factor(year))) +
  geom_histogram(bins = 50, binwidth = 0.8, position = "identity") +
  geom_density(aes(y = after_stat(count) * 1.5,colour = factor(year), group = year), alpha = .3) +
  facet_wrap(~locality) +
  theme_bw() +
  labs(title = "Plant degree distribution",
       x = "Degree",
       y = "Frequency") +
  scale_fill_manual(name = "Year",values = c("2021" = "black", "2024" = "tomato4")) +
  scale_color_manual(name = "Year",values = c("2021" = "black", "2024" = "tomato4")) +
  scale_alpha_manual(name = "Year",values = c("2021" = 0.8, "2024" = 0.2))  + theme(
  plot.title = element_text(size=18, face= "bold"), 
  axis.text = element_text(size=12),
  panel.border = element_rect(size=1.3), 
  strip.text = element_text(size=14, face = "bold"),
  strip.background = element_blank())+
coord_cartesian(expand = FALSE)


library(patchwork)

p1/p2

```


### \textcolor{gray}{2. Network descriptors}

```{r echo=F, fig.align='center', message=FALSE, warning=FALSE}


#Load r data
#Read data from 2021 and 2024
#First,load libraries
library(dplyr)
library(reshape2)
library(stringr)
library(ggplot2)
#Read data
data_2021 = read.csv("../Data/life_polinizadores_2021.csv")
data_2024 = read.csv("../Data/life_polinizadores_2024.csv")
#Combine data
all_data = bind_rows(data_2021, data_2024)
#Rename ejea caballeros to only ejea
all_data = all_data %>%
mutate(site_id = if_else(site_id == "ejea caballeros",
                "ejea", site_id))

#Delete leading and trailing spaces in spp names
all_data = all_data %>%
mutate(pollinators = trimws(pollinators)) %>%
mutate(plants = trimws(plants))

#Create a site_id label with year
#and select only cols of interest
main_cols = all_data %>%
mutate(locality = site_id) %>%
mutate(date = paste(day,month,year,transect, sep = "_")) %>%
mutate(site_id = paste0(site_id, "_" ,year)) %>%
mutate(site_id = str_replace_all(site_id, " ", "_")) %>%
select(locality, site_id, year, date, transect,  plants, pollinators)

#Get number of species of plants and pollinators
#per location and year (site_id has already year on it)
n_spp_poll = main_cols %>%
group_by(locality, year) %>%
filter(!str_detect(pollinators, " sp"))  %>% 
summarise(n_pollinators = n_distinct(pollinators))
n_spp_plant = main_cols %>%
group_by(locality, year) %>%
filter(!str_detect(plants, " sp"))  %>% 
summarise(n_plants= n_distinct(plants))
#Bind both datasets
n_spp = left_join(n_spp_poll, n_spp_plant)

#Prepare data to laod markdown
can_2021 = n_spp %>% 
filter(locality == "cantavieja" & year == "2021")
can_2024 = n_spp %>% 
filter(locality == "cantavieja" & year == "2024")
eje_2021 = n_spp %>% 
filter(locality == "ejea" & year == "2021")
eje_2024 = n_spp %>% 
filter(locality == "ejea" & year == "2024")

#Get total number of interactions recorded per study
interactions = main_cols %>% 
group_by(locality, year) %>% 
summarise(Interactions = n())
#Prepare data of interactions to laod markdown
can_2021_int = interactions %>% 
filter(locality == "cantavieja" & year == "2021")
can_2024_int = interactions %>% 
filter(locality == "cantavieja" & year == "2024")
eje_2021_int = interactions %>% 
filter(locality == "ejea" & year == "2021")
eje_2024_int = interactions %>% 
filter(locality == "ejea" & year == "2024")

```

In this section, we describe the plant-pollinator networks by location and year and evaluate their level of spcialization (H2') and connectance using the bipartite package [@dormann2008].

**Cantavieja**

Cantavieja had `r can_2021$n_pollinators` pollinators and `r can_2021$n_plants` plant species in 2021 and `r can_2024$n_pollinators` pollinators and `r can_2024$n_plants` plants in 2024. The total number of recorded interactions was `r can_2021_int$Interactions` in 2021 and `r can_2024_int$Interactions` in 2024. 

**Ejea de los Caballeros**

Ejea de los Caballeros had `r eje_2021$n_pollinators` pollinators and `r eje_2021$n_plants` plant species in 2021 and `r eje_2024$n_plants` pollinators and `r eje_2024$n_plants` plants in 2024. The total number of recorded interactions was `r eje_2021_int$Interactions` in 2021 and `r eje_2024_int$Interactions` in 2024.


```{r echo=F, fig.align='center', message=FALSE, warning=FALSE, out.width="85%", fig.width=10,fig.height=4, fig.cap="\\textbf{Figure 6.} Comparison of network specialization and connectance for Cantavieja and Ejea de los Caballeros across sampling years."}

library(bipartite)
library(purrr)
library(tidyr)

matrices_list = readRDS("../Data/matrices_list.rds")
#Compute specialization
H2_results = map(matrices_list, H2fun, H2_integer=TRUE)
network_h2 = bind_rows(H2_results, .id = "Site_id")
network_h2 = network_h2 %>%
select(Site_id, H2)
#Compute connectance
connectance_results = map(matrices_list, networklevel, index="connectance")
network_connectance = bind_rows(connectance_results, .id = "Site_id")
#Bind metric data
metrics = left_join(network_h2,network_connectance)
#Separate Site_id again for plotting
for_plotting = metrics %>%
separate(Site_id, c("site", "Year"), "_") %>%
mutate(site = str_to_title(site)) %>%
rename(Connectance = connectance)
#Plot data
p1 = for_plotting %>%
ggplot(aes(site, H2, fill = Year), group = Year) +
geom_col(position = "dodge", alpha=0.9) +
scale_fill_manual(values = c("black", "tomato4")) +
theme_bw() +
coord_cartesian(expand = FALSE) +
xlab(NULL) +
ylab("Species") +
ggtitle("Network specialization (H2')")+ theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))


p2 = for_plotting %>%
ggplot(aes(site, Connectance, fill = Year), group = Year) +
geom_col(position = "dodge", alpha=0.9) +
scale_fill_manual(values = c("black", "tomato4")) +
theme_bw() +
coord_cartesian(expand = FALSE) +
xlab(NULL) +
ylab("Species") +
ggtitle("Connectance")+ theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))


p1 + p2



```


### \textcolor{gray}{3. Network descriptors}

Nestedness
Robustness

## Conclusions


## References


