---
output:
  pdf_document: default
  word_document: default
bibliography: ../references.bib
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage[skip=3pt]{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{setspace}
- \usepackage{titlesec}
- \titlespacing{\title}{0pt}{\parskip}{-\parskip}
- \usepackage[style=apa]{biblatex}
- \usepackage[labelformat = empty]{caption}
- \usepackage{pdflscape}
---

# Report on plant-pollinator network description from Cantavieja and Ejea de los Caballeros

**Data collection: O. Aguado**  
**Analysis: J. B. Lanuza and I. Bartomeus**  
**Coordination: E. Nuñez**  
**Date: 2025**  


```{r setup, echo=FALSE, warning=FALSE}
# set global chunk options: 
library(knitr)
opts_chunk$set(cache=FALSE, autodep = TRUE)
#dep_auto()

```

## Objectives

The objective of this report is to describe the differences between two plant-pollinator communities located in Cantavieja and Ejea de los Caballeros before and after restoration has taken place. The effect of restoration was evaluated by comparing rarefied species richness and main aspects of network structure across sampling years.

## Field sampling

Two distinct locations were monitored with different historical land-use and management in the region of Aragón (Spain): Cantavieja (40º 30' 44", N 0º 22' 59" W) at 1450m above sea level with a total of 30 plots and Ejea de los Caballeros (42º 01' 06" N, 1º 08' 53" W) at 350m. In each location, a total of 21 plots were monitored in 2021 and 2024. Plot size is 2m by 2m and they are randomly distributed within each location (see **Figure 1**). Importantly, since the start of the project vegetation has remained undisturbed without grazing or clearing. 

Each plot was surveyed three times at the begining of the season, at the peak of flowering and at the end of the season. In each occasion, all plant-pollinator interactions observed were documented. Pollinator specimens not identified in the field were captured and identified in the lab.


```{r echo=FALSE, out.width='100%', fig.cap="\\textbf{Figure 1.} Cantavieja (left) and Ejea de los Caballeros (right) locations with the different sampling plots indicated with an orange square plus the plot identifier. The position of the bee hives is shown with a white cross for both locations."}

knitr::include_graphics('../Images/Sampling_sites.png')
```

## Species richness

In this section, we first described the species accumulation curves per location and year. This involves using rarefaction analysis to compare fairly the number of species across sampling rounds sampling rounds. This process involves creating several species accumulation curves by randomly selecting each sampling round, and then calculating the mean of all these curves. Cantavieja and Ejea de los Caballeros consistently showed a higher number of pollinator species for the same number of sampling rounds in the year 2024. (**Figure 3**). This difference between years was particularly pronounced for Ejea de los Caballeros.


```{r echo=F, fig.align='center', message=FALSE, warning=FALSE, out.width="85%", fig.width=10, fig.cap="\\textbf{Figure 2.} Rarefied species accumulation curves across sampling rounds in Cantavieja and Ejea de los Caballeros. The solid line indicates the rarefied number of species per sampling round, the dot represents the observed number of species, and the dashed line shows the extrapolated number of species if additional rounds were conducted."}

library(cowplot)
library(ggplot2)

p1 = readRDS("../Data/cantavieja_sampling_curve.rds")
p2 = readRDS("../Data/ejea_sampling_curve.rds")

p1 = p1 + theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))
p2 = p2 + theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
  axis.title = element_text(size=14),
                axis.text = element_text(size=12))

plot_grid(p1, p2)

```


Second, we compared the number of observed pollinator and plant species per location and year. As showed in **Figure 3**, both Cantavieja and Ejea de los Caballeros showed more pollinator species in the year 2024 (**Figure 4**). However, the number of observed plant species was higher in 2021 for both locations. 

```{r echo=F, fig.align='center', message=FALSE, warning=FALSE, out.width="85%", fig.width=10, fig.cap="\\textbf{Figure 3.} Pollinator and plant richness in Cantavieja and Ejea de los Caballeros for the sampling periods 2021 and 2024."}

#Read data from 2021 and 2024
#First,load libraries
library(dplyr)
library(reshape2)
library(stringr)
library(ggplot2)
#Read data
data_2021 = read.csv("../Data/life_polinizadores_2021.csv")
data_2024 = read.csv("../Data/life_polinizadores_2024.csv")
#Combine data
all_data = bind_rows(data_2021, data_2024)
#Rename ejea caballeros to only ejea
all_data = all_data %>%
mutate(site_id = if_else(site_id == "ejea caballeros",
                "ejea", site_id))

#Delete leading and trailing spaces in spp names
all_data = all_data %>%
mutate(pollinators = trimws(pollinators)) %>%
mutate(plants = trimws(plants))

#Create a site_id label with year
#and select only cols of interest
main_cols = all_data %>%
mutate(locality = site_id) %>%
mutate(date = paste(day,month,year,transect, sep = "_")) %>%
mutate(site_id = paste0(site_id, "_" ,year)) %>%
mutate(site_id = str_replace_all(site_id, " ", "_")) %>%
select(locality, site_id, date, transect,  plants, pollinators)

#Get number of species of plants and pollinators
#per location and year (site_id has already year on it)
n_spp = main_cols %>%
group_by(site_id) %>%
summarise(n_pollinators = n_distinct(pollinators),
          n_plants = n_distinct(plants))

n_spp$site = c("Cantavieja", "Cantavieja","Ejea", "Ejea")
n_spp$Year = c("2021", "2024","2021", "2024")

p1 = n_spp %>%
ggplot(aes(site, n_pollinators, fill = Year), group = Year) +
geom_col(position = "dodge", alpha=0.9) +
scale_fill_manual(values = c("black", "tomato4")) +
theme_bw() +
coord_cartesian(expand = FALSE) +
xlab(NULL) +
ylab("Species") +
ggtitle("Pollinators")+ theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))


p2 = n_spp %>%
ggplot(aes(site, n_plants, fill = Year), group = Year) +
geom_col(position = "dodge", alpha=0.9) +
scale_fill_manual(values = c("black", "tomato4")) +
theme_bw() +
coord_cartesian(expand = FALSE) +
xlab(NULL) +
ylab("Species") +
ggtitle("Plants")+ theme(plot.title = element_text(size=18, face= "bold"), panel.border = element_rect(size=1.3),
                axis.title = element_text(size=14),
                axis.text = element_text(size=12))

library(cowplot)
plot_grid(p1, p2)



```

Things to do:

Rarefaction analysis: interactions



```{r, echo=F, warning=FALSE,message=FALSE}

#DATA PREPARATION

#Data processing and preparation for visualization and analysis

#First,load libraries
library(dplyr)
library(reshape2)
library(bipartite)

#Read data
data <- read.csv("../Data/life_polinizadores_2021.csv")

#check structure of the data
#str(data)

#create separate datasets for the two different locations
canta <- data %>% filter(site_id=="cantavieja")
ejea <- data %>% filter(site_id=="ejea caballeros")

#select for now plant and pollinator species to create plant-pollinator networks from transects
canta_species <- canta %>% select(c("plants", "pollinators"))
ejea_species <- ejea %>% select(c("plants", "pollinators"))

#Now aggregate pollinator visits per plant species
canta_aggreagted <- canta_species %>% count(plants, pollinators, sort = TRUE)
ejea_aggreagted <-  ejea_species %>% count(plants, pollinators, sort = TRUE)

#Now convert to a matrix with the help of acast function from reshape library
canta_matrix <- acast(canta_aggreagted, plants~pollinators, value.var="n")
ejea_matrix <- acast(ejea_aggreagted, plants~pollinators, value.var="n")

#Convert NA's to zeros
canta_matrix[is.na(canta_matrix)] <- 0
ejea_matrix[is.na(ejea_matrix)] <- 0

ntw_canta <- networklevel(canta_matrix, index = c("connectance", 
                                                  "number of species",
                                                  "robustness")) #1 super robust.
ntw_ejea <- networklevel(ejea_matrix, index = c("connectance", 
                                                  "number of species",
                                                  "robustness")) #1 super robust.

ch <- H2fun(canta_matrix, H2_integer=TRUE)
ch <- format(round(ch, 2), nsmall = 2)
ch <- as.numeric(ch) 

eh <- H2fun(ejea_matrix, H2_integer=TRUE)
eh <- format(round(eh, 2), nsmall = 2)
eh <- as.numeric(eh) 
```

\newpage

